# Arcana Writer 開発仕様書

**文書番号:** AW-SPEC-001  
**バージョン:** 1.0  
**最終更新日:** 2025年10月1日  
**作成者:** Arcana Writer開発チーム

## 目次

1. [プロジェクト概要](#1-プロジェクト概要)
2. [システムアーキテクチャ](#2-システムアーキテクチャ)
3. [技術スタック](#3-技術スタック)
4. [機能要件](#4-機能要件)
5. [データモデル](#5-データモデル)
6. [API仕様](#6-api仕様)
7. [ユーザーインターフェース](#7-ユーザーインターフェース)
8. [開発タスク詳細](#8-開発タスク詳細)
9. [品質要件](#9-品質要件)
10. [開発スケジュール](#10-開発スケジュール)
11. [付録](#11-付録)

---

## 1. プロジェクト概要

### 1.1 製品ビジョン

Arcana Writer（アルカナ・ライター）は、AIを活用して創作プロセス全体をサポートする執筆支援ツールです。単なる文章生成ではなく、プロットの構造分析、文体の一貫性維持、アイデア生成といった、作家が自身の感覚に頼らざるを得なかった領域を、データとAIによって客観的に可視化します。

### 1.2 コンセプト

「あなたの物語に、客観的な『もう一人の自分』を。」

このツールは、単なる文章作成ツールではなく、作家の創造性を最大限に引き出すための、AIを搭載した「執筆参謀」です。

### 1.3 MVP（実用最小限の製品）の目標

MVPでは、以下の3つの主要コンポーネントを実装します：

1. **基盤機能**: ユーザー認証、プロジェクト管理など
2. **テキストエディタ機能**: 文章執筆の基本機能と校正
3. **プロット・コンパス機能**: 物語構造の分析・可視化（核心的価値）

### 1.4 ターゲットユーザー

- Web小説作家
- 同人作家
- 小説投稿サイトユーザー
- 商業作家
- シナリオライター

---

## 2. システムアーキテクチャ

### 2.1 全体アーキテクチャ

Arcana Writerは、モダンなウェブアプリケーションとして、フロントエンド、バックエンド、データベース、AIサービスの4つの主要コンポーネントで構成されます。

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│   フロントエンド   │◄────►│    バックエンド   │◄────►│   データベース   │
│   (Next.js)     │     │   (NestJS)     │     │  (PostgreSQL)  │
│                 │     │                 │     │                 │
└─────────────────┘     └────────┬────────┘     └─────────────────┘
                                 │
                                 ▼
                        ┌─────────────────┐
                        │                 │
                        │   AIサービス    │
                        │  (Claude API)   │
                        │                 │
                        └─────────────────┘
```

### 2.2 デプロイメント構成

- **フロントエンド**: Vercel（サーバーレスデプロイ）
- **バックエンド**: AWS Lambda（サーバーレス関数）
- **データベース**: Supabase（PostgreSQLマネージドサービス）
- **ファイルストレージ**: AWS S3
- **CDN**: Vercel Edge Network

---

## 3. 技術スタック

### 3.1 フロントエンド

- **フレームワーク**: React (Next.js)
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS
- **状態管理**: React Context API
- **テキストエディタ**: Tiptap
- **グラフ描画**: Chart.js
- **HTTP通信**: Axios

### 3.2 バックエンド

- **フレームワーク**: NestJS
- **言語**: TypeScript
- **認証**: JWT (JSON Web Tokens)
- **バリデーション**: class-validator
- **ドキュメント**: Swagger/OpenAPI

### 3.3 データベース

- **RDBMS**: PostgreSQL
- **ORM**: TypeORM
- **マネージドサービス**: Supabase

### 3.4 AI・外部サービス

- **テキスト分析**: Claude 3.5 Haiku API
- **認証基盤**: Firebase Authentication

### 3.5 開発ツール

- **バージョン管理**: Git/GitHub
- **CI/CD**: GitHub Actions
- **コミュニケーション**: Slack
- **デザイン**: Figma
- **プロジェクト管理**: GitHub Projects

---

## 4. 機能要件

### 4.1 基盤機能

#### 4.1.1 ユーザー認証

- ユーザー登録（メールアドレス、パスワード）
- ログイン/ログアウト
- パスワードリセット
- ソーシャルログイン（Google）

#### 4.1.2 プロジェクト管理

- プロジェクト作成
- プロジェクト一覧表示
- プロジェクト編集
- プロジェクト削除
- プロジェクト設定（タイトル、説明、ジャンル等）

### 4.2 テキストエディタ機能

#### 4.2.1 基本エディタ

- リッチテキスト編集（見出し、太字、斜体、リスト等）
- 自動保存
- 変更履歴
- ドキュメント内検索

#### 4.2.2 校正機能

- 文法・表記ミスの検出
- 文体の一貫性チェック
- 表現の多様性分析
- 読みやすさスコア

### 4.3 プロット・コンパス機能

#### 4.3.1 構造分析

- ペース配分の可視化（チャート）
- 章・節ごとの文字数分析
- 盛り上がりポイントの検出

#### 4.3.2 キャラクター分析

- 登場人物の抽出
- 登場頻度の可視化
- キャラクター関係図

#### 4.3.3 伏線管理

- 伏線の検出
- 伏線の回収状況トラッキング
- 未回収伏線のアラート

---

## 5. データモデル

### 5.1 ER図

```
┌───────────────┐       ┌───────────────┐       ┌───────────────┐
│     User      │       │    Project    │       │   Document    │
├───────────────┤       ├───────────────┤       ├───────────────┤
│ id            │       │ id            │       │ id            │
│ email         │       │ title         │       │ title         │
│ password_hash │       │ description   │       │ content       │
│ name          │       │ genre         │       │ created_at    │
│ created_at    │       │ created_at    │       │ updated_at    │
│ updated_at    │       │ updated_at    │       │ project_id    │
└───────┬───────┘       │ user_id       │       └───────┬───────┘
        │               └───────┬───────┘               │
        │                       │                       │
        └───────────────────────┼───────────────────────┘
                                │
                                ▼
                      ┌───────────────────┐
                      │     Analysis      │
                      ├───────────────────┤
                      │ id                │
                      │ pace_data         │
                      │ character_data    │
                      │ foreshadow_data   │
                      │ created_at        │
                      │ updated_at        │
                      │ document_id       │
                      └───────────────────┘
```

### 5.2 テーブル定義

#### 5.2.1 User テーブル

| フィールド名 | データ型 | 説明 |
|:---|:---|:---|
| id | UUID | プライマリキー |
| email | VARCHAR(255) | ユーザーのメールアドレス（一意） |
| password_hash | VARCHAR(255) | ハッシュ化されたパスワード |
| name | VARCHAR(100) | ユーザー名 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### 5.2.2 Project テーブル

| フィールド名 | データ型 | 説明 |
|:---|:---|:---|
| id | UUID | プライマリキー |
| title | VARCHAR(255) | プロジェクトのタイトル |
| description | TEXT | プロジェクトの説明 |
| genre | VARCHAR(50) | ジャンル |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |
| user_id | UUID | 外部キー（User） |

#### 5.2.3 Document テーブル

| フィールド名 | データ型 | 説明 |
|:---|:---|:---|
| id | UUID | プライマリキー |
| title | VARCHAR(255) | ドキュメントのタイトル |
| content | JSONB | リッチテキスト内容（Tiptap JSON形式） |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |
| project_id | UUID | 外部キー（Project） |

#### 5.2.4 Analysis テーブル

| フィールド名 | データ型 | 説明 |
|:---|:---|:---|
| id | UUID | プライマリキー |
| pace_data | JSONB | ペース分析データ |
| character_data | JSONB | キャラクター分析データ |
| foreshadow_data | JSONB | 伏線分析データ |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |
| document_id | UUID | 外部キー（Document） |

---

## 6. API仕様

### 6.1 認証API

#### 6.1.1 ユーザー登録

- **エンドポイント**: `POST /api/auth/register`
- **リクエスト**:
  ```json
  {
    "email": "user@example.com",
    "password": "securePassword123",
    "name": "山田太郎"
  }
  ```
- **レスポンス**:
  ```json
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "email": "user@example.com",
    "name": "山田太郎",
    "created_at": "2025-10-01T09:00:00Z"
  }
  ```

#### 6.1.2 ログイン

- **エンドポイント**: `POST /api/auth/login`
- **リクエスト**:
  ```json
  {
    "email": "user@example.com",
    "password": "securePassword123"
  }
  ```
- **レスポンス**:
  ```json
  {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "email": "user@example.com",
      "name": "山田太郎"
    }
  }
  ```

### 6.2 プロジェクトAPI

#### 6.2.1 プロジェクト一覧取得

- **エンドポイント**: `GET /api/projects`
- **ヘッダー**: `Authorization: Bearer {token}`
- **レスポンス**:
  ```json
  {
    "projects": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440001",
        "title": "星の砂時計",
        "description": "SF小説のプロジェクト",
        "genre": "SF",
        "created_at": "2025-09-15T14:30:00Z",
        "updated_at": "2025-09-30T10:15:00Z"
      },
      {
        "id": "550e8400-e29b-41d4-a716-446655440002",
        "title": "月光の誓い",
        "description": "ファンタジー小説のプロジェクト",
        "genre": "ファンタジー",
        "created_at": "2025-09-20T09:45:00Z",
        "updated_at": "2025-09-28T16:20:00Z"
      }
    ]
  }
  ```

#### 6.2.2 プロジェクト作成

- **エンドポイント**: `POST /api/projects`
- **ヘッダー**: `Authorization: Bearer {token}`
- **リクエスト**:
  ```json
  {
    "title": "新しいプロジェクト",
    "description": "新しいプロジェクトの説明",
    "genre": "ミステリー"
  }
  ```
- **レスポンス**:
  ```json
  {
    "id": "550e8400-e29b-41d4-a716-446655440003",
    "title": "新しいプロジェクト",
    "description": "新しいプロジェクトの説明",
    "genre": "ミステリー",
    "created_at": "2025-10-01T10:00:00Z",
    "updated_at": "2025-10-01T10:00:00Z"
  }
  ```

### 6.3 ドキュメントAPI

#### 6.3.1 ドキュメント取得

- **エンドポイント**: `GET /api/documents/{id}`
- **ヘッダー**: `Authorization: Bearer {token}`
- **レスポンス**:
  ```json
  {
    "id": "550e8400-e29b-41d4-a716-446655440004",
    "title": "第1章：始まりの朝",
    "content": {
      "type": "doc",
      "content": [
        {
          "type": "paragraph",
          "content": [
            {
              "type": "text",
              "text": "物語の本文がここに入ります..."
            }
          ]
        }
      ]
    },
    "created_at": "2025-09-25T11:30:00Z",
    "updated_at": "2025-10-01T09:45:00Z"
  }
  ```

#### 6.3.2 ドキュメント保存

- **エンドポイント**: `PUT /api/documents/{id}`
- **ヘッダー**: `Authorization: Bearer {token}`
- **リクエスト**:
  ```json
  {
    "title": "第1章：始まりの朝（改訂版）",
    "content": {
      "type": "doc",
      "content": [
        {
          "type": "paragraph",
          "content": [
            {
              "type": "text",
              "text": "更新された物語の本文..."
            }
          ]
        }
      ]
    }
  }
  ```
- **レスポンス**:
  ```json
  {
    "id": "550e8400-e29b-41d4-a716-446655440004",
    "title": "第1章：始まりの朝（改訂版）",
    "updated_at": "2025-10-01T10:15:00Z"
  }
  ```

### 6.4 分析API

#### 6.4.1 ペース分析データ取得

- **エンドポイント**: `GET /api/analysis/pace/{document_id}`
- **ヘッダー**: `Authorization: Bearer {token}`
- **レスポンス**:
  ```json
  {
    "document_id": "550e8400-e29b-41d4-a716-446655440004",
    "total_words": 5240,
    "sections": [
      {
        "id": 1,
        "title": "導入部",
        "word_count": 850,
        "intensity_score": 0.4,
        "pace_score": 0.3
      },
      {
        "id": 2,
        "title": "展開部",
        "word_count": 1650,
        "intensity_score": 0.6,
        "pace_score": 0.5
      },
      {
        "id": 3,
        "title": "クライマックス",
        "word_count": 1200,
        "intensity_score": 0.9,
        "pace_score": 0.8
      },
      {
        "id": 4,
        "title": "結末",
        "word_count": 1540,
        "intensity_score": 0.7,
        "pace_score": 0.6
      }
    ]
  }
  ```

#### 6.4.2 キャラクター分析データ取得

- **エンドポイント**: `GET /api/analysis/characters/{document_id}`
- **ヘッダー**: `Authorization: Bearer {token}`
- **レスポンス**:
  ```json
  {
    "document_id": "550e8400-e29b-41d4-a716-446655440004",
    "characters": [
      {
        "id": 1,
        "name": "佐藤健太",
        "mentions": 124,
        "sections_present": [1, 2, 3, 4],
        "importance_score": 0.9
      },
      {
        "id": 2,
        "name": "鈴木美咲",
        "mentions": 98,
        "sections_present": [1, 2, 4],
        "importance_score": 0.7
      },
      {
        "id": 3,
        "name": "田中博士",
        "mentions": 45,
        "sections_present": [2, 3],
        "importance_score": 0.5
      }
    ]
  }
  ```

#### 6.4.3 伏線分析データ取得

- **エンドポイント**: `GET /api/analysis/foreshadowing/{document_id}`
- **ヘッダー**: `Authorization: Bearer {token}`
- **レスポンス**:
  ```json
  {
    "document_id": "550e8400-e29b-41d4-a716-446655440004",
    "foreshadowing_elements": [
      {
        "id": 1,
        "description": "謎の手紙",
        "introduced_at": {
          "section": 1,
          "position": 450
        },
        "resolved_at": {
          "section": 3,
          "position": 850
        },
        "status": "resolved"
      },
      {
        "id": 2,
        "description": "鍵のない部屋",
        "introduced_at": {
          "section": 2,
          "position": 320
        },
        "resolved_at": null,
        "status": "unresolved"
      }
    ]
  }
  ```

---

## 7. ユーザーインターフェース

### 7.1 画面構成

#### 7.1.1 認証画面

- サインアップページ
- ログインページ
- パスワードリセットページ

#### 7.1.2 ダッシュボード画面

- プロジェクト一覧
- 新規プロジェクト作成
- プロジェクト設定

#### 7.1.3 エディタ画面

- メインエディタ領域
- ツールバー（書式設定）
- サイドパネル（分析結果表示）
- 校正結果表示エリア

### 7.2 UI/UXガイドライン

#### 7.2.1 カラーパレット

- **プライマリカラー**: #16213E（ダークブルー）
- **アクセントカラー**: #E94560（ピンクレッド）
- **テキストカラー**: #FFFFFF（白）
- **テキストセカンダリ**: #CCCCCC（ライトグレー）
- **背景色**: #0F3460（ダークブルー）
- **カードバックグラウンド**: rgba(255, 255, 255, 0.05)（半透明ホワイト）

#### 7.2.2 タイポグラフィ

- **フォントファミリー**: 'Noto Sans JP', sans-serif
- **見出し**: 太字、1.2行間
- **本文**: 標準、1.6行間

#### 7.2.3 コンポーネント

- ボタン
- カード
- フォーム要素
- モーダル
- ドロップダウン
- タブ
- アラート

---

## 8. 開発タスク詳細

### 8.1 基盤機能タスク

#### 8.1.1 A-1: DBスキーマ設計 (User, Project)

**目的**: ユーザー情報とプロジェクト情報を保存するためのデータベーススキーマを設計する

**作業内容**:
1. User テーブルの設計（id, email, password_hash, name, created_at, updated_at）
2. Project テーブルの設計（id, title, description, genre, created_at, updated_at, user_id）
3. テーブル間のリレーション設定
4. インデックス設計
5. マイグレーションファイルの作成

**成果物**: 
- SQL定義ファイル
- TypeORMエンティティファイル
- マイグレーションスクリプト

**工数**: 1日
**難易度**: 低

#### 8.1.2 A-2: ユーザー登録APIの実装

**目的**: ユーザーがサービスに登録できるようにするためのAPIを実装する

**作業内容**:
1. ユーザー登録DTOの作成（バリデーション含む）
2. ユーザーサービスの実装（パスワードハッシュ化含む）
3. ユーザーコントローラーの実装
4. ユニットテストの作成
5. E2Eテストの作成

**成果物**:
- NestJSコントローラー
- NestJSサービス
- DTOクラス
- テストコード

**工数**: 2日
**難易度**: 中

#### 8.1.3 A-3: ログインAPIの実装 (JWT認証)

**目的**: ユーザーが安全にログインできるようにするためのAPIを実装する

**作業内容**:
1. JWT認証戦略の実装
2. ログインDTOの作成
3. 認証サービスの実装
4. 認証コントローラーの実装
5. JWTガードの実装
6. テストコードの作成

**成果物**:
- JWT認証モジュール
- 認証コントローラー
- 認証サービス
- テストコード

**工数**: 2日
**難易度**: 中

### 8.2 テキストエディタ機能タスク

#### 8.2.1 B-3: リッチテキストエディタの導入 (Tiptap)

**目的**: ユーザーが文章を執筆するためのリッチテキストエディタを実装する

**作業内容**:
1. Tiptapライブラリのインストールと設定
2. 基本的なエディタコンポーネントの作成
3. ツールバーの実装（見出し、太字、斜体、リスト等）
4. エディタの状態管理の実装
5. コンテンツの保存形式（JSON）の定義

**成果物**:
- Reactエディタコンポーネント
- ツールバーコンポーネント
- エディタコンテキスト

**工数**: 3日
**難易度**: 中

#### 8.2.2 B-4: エディタの自動保存機能の実装

**目的**: ユーザーの執筆内容を自動的に保存し、データ損失を防ぐ

**作業内容**:
1. 変更検知ロジックの実装
2. 自動保存のタイミング設定（アイドル時、定期的）
3. 保存状態の表示UI実装
4. エラーハンドリングの実装
5. オフライン対応（ローカルストレージ活用）

**成果物**:
- 自動保存ロジック
- 保存状態表示コンポーネント
- オフライン対応機能

**工数**: 2日
**難易度**: 中

### 8.3 プロット・コンパス機能タスク

#### 8.3.1 C-2: ペース配分チャート用データ集計API

**目的**: 物語のペース配分を分析し、可視化するためのデータを提供する

**作業内容**:
1. テキスト分割ロジックの実装（章、節、段落）
2. Claude APIを使用した感情強度分析の実装
3. ペース配分スコア計算アルゴリズムの実装
4. データ集計エンドポイントの作成
5. キャッシュ戦略の実装

**成果物**:
- データ分析サービス
- APIエンドポイント
- Claude API連携モジュール

**工数**: 4日
**難易度**: 高

#### 8.3.2 C-3: ペース配分チャートの描画 (Chart.js)

**目的**: 分析結果をユーザーに視覚的に伝えるためのチャートを実装する

**作業内容**:
1. Chart.jsの導入と設定
2. ペース配分チャートコンポーネントの作成
3. データフェッチングロジックの実装
4. インタラクティブ機能の追加（ホバー、クリック）
5. レスポンシブ対応

**成果物**:
- チャートコンポーネント
- データ取得ロジック
- インタラクティブ機能

**工数**: 2日
**難易度**: 中

---

## 9. 品質要件

### 9.1 パフォーマンス要件

- ページ読み込み時間: 2秒以内
- API応答時間: 500ms以内
- エディタの入力遅延: 50ms以内
- 自動保存の頻度: 30秒ごと

### 9.2 セキュリティ要件

- HTTPS通信の強制
- JWTトークンの有効期限: 24時間
- パスワードハッシュ化: bcrypt（コスト係数10）
- CSRF対策の実装
- XSS対策の実装
- レート制限: 1分間に60リクエストまで

### 9.3 テスト要件

- ユニットテストカバレッジ: 80%以上
- E2Eテスト: 主要ユーザーフロー
- 負荷テスト: 同時100ユーザーアクセス時の応答時間
- クロスブラウザテスト: Chrome, Firefox, Safari, Edge

### 9.4 アクセシビリティ要件

- WCAG 2.1 AA準拠
- スクリーンリーダー対応
- キーボードナビゲーション対応
- カラーコントラスト比: 4.5:1以上

---

## 10. 開発スケジュール

### 10.1 フェーズ1: 基盤開発

- 週1: 環境構築、DBスキーマ設計
- 週2: 認証機能実装
- 週3: プロジェクト管理機能実装
- 週4: テスト、バグ修正

### 10.2 フェーズ2: エディタ開発

- 週1: エディタ基本機能実装
- 週2: 自動保存機能実装
- 週3: 校正機能連携
- 週4: テスト、バグ修正

### 10.3 フェーズ3: 分析機能開発

- 週1-2: ペース分析機能実装
- 週3-4: キャラクター分析機能実装
- 週5: 伏線管理機能実装
- 週6: テスト、バグ修正

### 10.4 フェーズ4: 統合・最適化

- 週1: 機能統合、UI/UX改善
- 週2: パフォーマンス最適化、最終テスト

---

## 11. 付録

### 11.1 用語集

- **プロット・コンパス**: 物語の構造を可視化し、バランスの取れたストーリー展開を支援する機能
- **スタイル・アナライザー**: 文体の一貫性を保ち、表現力豊かな文章へと導く機能
- **ミューズ・エンジン**: 執筆中の文脈に基づき、次の展開やアイデアを提案する機能

### 11.2 参考資料

- [Tiptap公式ドキュメント](https://tiptap.dev/docs)
- [NestJS公式ドキュメント](https://docs.nestjs.com/)
- [Claude API公式ドキュメント](https://docs.anthropic.com/claude/reference/getting-started-with-the-api)

### 11.3 変更履歴

| バージョン | 日付 | 変更内容 | 担当者 |
|:---|:---|:---|:---|
| 0.1 | 2025-09-15 | 初稿作成 | 開発チーム |
| 0.5 | 2025-09-22 | 機能要件詳細化 | 開発チーム |
| 0.8 | 2025-09-28 | API仕様追加 | 開発チーム |
| 1.0 | 2025-10-01 | 最終版確定 | 開発チーム |
